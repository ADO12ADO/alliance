FROM golang:1.18.7-bullseye AS build

RUN apt update && apt install bash curl jq build-essential git tar -y

WORKDIR /work
COPY . /work

RUN curl https://get.ignite.com/cli@v0.24.0! | bash
RUN ignite chain build --output /work/

FROM alpine AS run
COPY ./scripts/build-wrapper.sh /usr/bin/build-wrapper.sh

VOLUME /allianced
COPY --from=build /work/allianced /allianced/
WORKDIR /allianced

EXPOSE 26656 26657 1317
ENTRYPOINT ["/usr/bin/build-wrapper.sh"]
CMD ["start", "--log_format", "plain"]
STOPSIGNAL SIGTERM
